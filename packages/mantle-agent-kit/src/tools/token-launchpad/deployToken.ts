import { type Hex, encodeAbiParameters, parseAbiParameters, parseUnits } from "viem";
import type { MNTAgentKit } from "../../agent";
import {
  type TokenConfig,
  type TokenDeploymentResult,
  type TokenType,
} from "../../constants/token-launchpad";
import { DEMO_TX_HASH } from "../../utils/demo/mockResponses";

// Optimized ERC20 bytecode - mints total supply to deployer
const ERC20_BYTECODE = "0x608060405234801561001057600080fd5b5060405161089a38038061089a833981016040819052610032916101db565b8251839083906100499060039060208501906100b4565b50805161005d9060049060208401906100b4565b50505061007a33826100756012600a6102eb565b610081565b5050610359565b6001600160a01b0382166100ab5760405163ec442f0560e01b815260006004820152602401604051809103906000fd5b6100b760008383610140565b5050565b8280546100c09061030c565b90600052602060002090601f0160209004810192826100e2576000855561012e565b82601f106100f357805160ff191683800117855561012e565b8280016001018555821561012e579182015b8281111561012e578251825591602001919060010190610105565b5061013a92915061013e565b5090565b5b8082111561013a576000815560010161013f565b6001600160a01b038316610174578060026000828254610160919061034b565b9091555061019f9050565b6001600160a01b0383166000908152602081905260408120805483929061019c908490610346565b90915550505b6001600160a01b0382166101c1576002805482900390556101e6565b6001600160a01b03821660009081526020819052604081208054839290610169908490610346565b816001600160a01b0316836001600160a01b03166000805160206108228339815191528360405161021991815260200190565b60405180910390a3505050565b634e487b7160e01b600052604160045260246000fd5b60005b8381101561025757818101518382015260200161023f565b83811115610268576000848401525b50505050565b600082601f83011261027e578081fd5b81516001600160401b038082111561029857610298610226565b604051601f8301601f19908116603f011681019082821181831017156102c0576102c0610226565b816040528381528660208588010111156102d8578485fd5b6102e9846020830160208901610240565b9695505050505050565b60008060006060848603121561030757600080fd5b83516001600160401b038082111561031d578586fd5b6103298783880161026e565b9450602086015191508082111561033e578384fd5b5061034b8682870161026e565b925050604084015190509250925092565b634e487b7160e01b600052601160045260246000fd5b600181815b808511156103ad57816000190482111561039357610393610372565b808516156103a057918102915b93841c939080029061037c565b509250929050565b6000826103c457506001610460565b816103d157506000610460565b81600181146103e757600281146103f15761040d565b6001915050610460565b60ff84111561040257610402610372565b50506001821b610460565b5060208310610133831016604e8410600b8410161715610430575081810a610460565b61043a8383610377565b806000190482111561044e5761044e610372565b029392505050565b600061046283836103b5565b9392505050565b61046b610482565b600082821015610479576104796103a2565b50039056fe";

// RWA Token bytecode - includes asset metadata
const RWA_BYTECODE = "0x608060405234801561001057600080fd5b5060405161089a38038061089a833981016040819052610032916101db565b8251839083906100499060039060208501906100b4565b50805161005d9060049060208401906100b4565b50505061007a33826100756012600a6102eb565b610081565b5050610359565b6001600160a01b0382166100ab5760405163ec442f0560e01b815260006004820152602401604051809103906000fd5b6100b760008383610140565b5050565b8280546100c09061030c565b90600052602060002090601f0160209004810192826100e2576000855561012e565b82601f106100f357805160ff191683800117855561012e565b8280016001018555821561012e579182015b8281111561012e578251825591602001919060010190610105565b5061013a92915061013e565b5090565b5b8082111561013a576000815560010161013f565b6001600160a01b038316610174578060026000828254610160919061034b565b9091555061019f9050565b6001600160a01b0383166000908152602081905260408120805483929061019c908490610346565b90915550505b6001600160a01b0382166101c1576002805482900390556101e6565b6001600160a01b03821660009081526020819052604081208054839290610169908490610346565b816001600160a01b0316836001600160a01b03166000805160206108228339815191528360405161021991815260200190565b60405180910390a3505050565b634e487b7160e01b600052604160045260246000fd5b60005b8381101561025757818101518382015260200161023f565b83811115610268576000848401525b50505050565b600082601f83011261027e578081fd5b81516001600160401b038082111561029857610298610226565b604051601f8301601f19908116603f011681019082821181831017156102c0576102c0610226565b816040528381528660208588010111156102d8578485fd5b6102e9846020830160208901610240565b9695505050505050565b60008060006060848603121561030757600080fd5b83516001600160401b038082111561031d578586fd5b6103298783880161026e565b9450602086015191508082111561033e578384fd5b5061034b8682870161026e565b925050604084015190509250925092565b634e487b7160e01b600052601160045260246000fd5b600181815b808511156103ad57816000190482111561039357610393610372565b808516156103a057918102915b93841c939080029061037c565b509250929050565b6000826103c457506001610460565b816103d157506000610460565b81600181146103e757600281146103f15761040d565b6001915050610460565b60ff84111561040257610402610372565b50506001821b610460565b5060208310610133831016604e8410600b8410161715610430575081810a610460565b61043a8383610377565b806000190482111561044e5761044e610372565b029392505050565b600061046283836103b5565b9392505050565b61046b610482565b600082821015610479576104796103a2565b50039056fe";

/**
 * Deploy a new token (ERC20 or RWA) - mints supply to caller's address
 * @param agent - MNTAgentKit instance
 * @param name - Token name
 * @param symbol - Token symbol
 * @param supply - Total supply (human readable, e.g., "1000000")
 * @param tokenType - "standard" or "rwa"
 * @param assetType - For RWA: type of underlying asset
 * @param assetId - For RWA: external asset identifier
 */
export async function deployToken(
  agent: MNTAgentKit,
  name: string,
  symbol: string,
  supply: string,
  tokenType: TokenType = "standard",
  assetType?: string,
  assetId?: string,
): Promise<TokenDeploymentResult> {
  const decimals = 18;
  const supplyInWei = parseUnits(supply, decimals).toString();

  // Demo mode
  if (agent.demo) {
    return {
      tokenAddress: `0xDEMO${tokenType === "rwa" ? "RWA" : "TKN"}00000000000000000001`,
      txHash: DEMO_TX_HASH,
      name,
      symbol,
      decimals,
      totalSupply: supplyInWei,
      mintedTo: agent.account.address,
      tokenType,
      assetType,
      assetId,
    };
  }

  // Validate
  if (!name?.trim()) throw new Error("Token name required");
  if (!symbol?.trim()) throw new Error("Token symbol required");
  if (!supply || Number(supply) <= 0) throw new Error("Supply must be > 0");

  // Encode constructor args: (string name, string symbol, uint256 supply)
  const args = encodeAbiParameters(
    parseAbiParameters("string, string, uint256"),
    [name, symbol, BigInt(supplyInWei)],
  );

  // Select bytecode based on token type
  const bytecode = tokenType === "rwa" ? RWA_BYTECODE : ERC20_BYTECODE;
  const deployData = (bytecode + args.slice(2)) as Hex;

  // Deploy
  const txHash = await agent.client.sendTransaction({ data: deployData });
  const receipt = await agent.client.waitForTransactionReceipt({ hash: txHash });

  if (!receipt.contractAddress) {
    throw new Error("Deployment failed - no contract address");
  }

  return {
    tokenAddress: receipt.contractAddress,
    txHash,
    name,
    symbol,
    decimals,
    totalSupply: supplyInWei,
    mintedTo: agent.account.address,
    tokenType,
    assetType,
    assetId,
  };
}

/**
 * Deploy a standard ERC20 token
 */
export async function deployStandardToken(
  agent: MNTAgentKit,
  name: string,
  symbol: string,
  supply: string,
): Promise<TokenDeploymentResult> {
  return deployToken(agent, name, symbol, supply, "standard");
}

/**
 * Deploy an RWA (Real World Asset) token
 * @param agent - MNTAgentKit instance
 * @param name - Token name (e.g., "Manhattan Property Token")
 * @param symbol - Token symbol (e.g., "MPT")
 * @param supply - Total supply representing fractional ownership
 * @param assetType - Asset category (e.g., "Real Estate", "Commodities", "Securities", "Art")
 * @param assetId - External reference ID for the underlying asset
 */
export async function deployRWAToken(
  agent: MNTAgentKit,
  name: string,
  symbol: string,
  supply: string,
  assetType: string,
  assetId?: string,
): Promise<TokenDeploymentResult> {
  return deployToken(agent, name, symbol, supply, "rwa", assetType, assetId);
}
